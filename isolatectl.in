#!/bin/sh -efu

. shell-error
. shell-git-config

isolate="@SBINDIR@/isolate-run"
configdir="@CONFIG@/isolate"

cfg="$configdir/config.ini"

show_help()
{
	cat <<-EOF
	Usage: $PROG {start|stop|status|restart} [NAME ...]

	Options:
	   -V, --version   output version information and exit;
	   -h, --help      display this help and exit.

	Report bugs to authors.

	EOF
	exit
}

print_version()
{
	cat <<-EOF
	$PROG version @VERSION@
	Written by Alexey Gladkov.

	Copyright (C) 2018  Alexey Gladkov <gladkov.alexey@gmail.com>
	This is free software; see the source for copying conditions.  There is NO
	warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
	EOF
	exit
}

show_usage()
{
	[ -z "$*" ] || message "$*"
	echo "Try \`$PROG --help' for more information." >&2
	exit 1
}

start()
{
	if [ -d "$cfg_lockdir/$name" ]; then
		printf "Isolation %s is already running.\n" "$name"
		return 0
	fi

	"$isolate" "$name"
}

stop()
{
	local pid

	if [ ! -d "$cfg_lockdir/$name" ]; then
		printf "Isolation %s is not running.\n" "$name"
		return 1
	fi

	[ ! -f "$cfg_lockdir/$name/pid" ] ||
		read pid < "$cfg_lockdir/$name/pid" ||:
	[ -z "$pid" ] ||
		kill -s TERM "$pid" ||:

	rm -rf -- "$cfg_lockdir/$name" >/dev/null 2>&1 ||:
}

status()
{
	local pid

	[ -d "$cfg_lockdir/$name" ] &&
		read pid < "$cfg_lockdir/$name/pid" &&
		kill -0 "$pid" ||
		return 1
}

TEMP=`getopt -n $PROG -o 'h,V' -l 'help,version' -- "$@"` ||
	show_usage
eval set -- "$TEMP"

while :; do
	case "$1" in
		-h|--help)
			show_help
			;;
		-V|--version)
			print_version
			;;
		--) shift
			break
			;;
		*)
			fatal "Unknown option: $1"
			;;
	esac
	shift
done

[ "$#" != 0 ] || show_usage
[ "$#" -ge 1 ] || show_usage "Error: more arguments required"

action="$1"; shift

[ -s "$cfg" ] ||
	fatal "config file not found: $cfg"

if [ "$#" = 0 ] && [ "$action" = "status" ]; then
	args="$(git_config_list_sections "$cfg" 'isolate' |cut -f2)"
	set -- $args
fi

[ "$#" != 0 ] ||
	show_usage "Error: more arguments required"

git_config_get cfg_lockdir "$cfg" "global.lockdir"
[ -n "$cfg_lockdir" ] || cfg_lockdir="/var/tmp"

rc=0
for name; do
	case "$action" in
		start)
			start || rc=$?
			;;
		stop)
			stop || rc=$?
			;;
		restart)
			stop && start || rc=$?
			;;
		status)
			if status; then
				s=running
			else
				rc=1
				s=stopped

				[ ! -d "$cfg_lockdir/$name" ] || {
					rc=2
					s=dead
				}
			fi
			printf "Isolation %s is %s.\n" "$name" "$s"
			;;
		*)
			show_usage "Error: unknown action: $action"
			;;
	esac
done

exit $rc
